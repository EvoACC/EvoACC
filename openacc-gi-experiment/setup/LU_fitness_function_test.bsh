#!/bin/bash

DIR=$(dirname $0)

status=0
{
  if [ ! -z "$1" ]; then
    (cd / && patch -p0) <$1
    status=$?
  fi
} &>/dev/null

if [ "$status" != "0" ]; then
  echo -1
  exit 0
fi


{
  #Weirdly enough, the compiler sometimes gets confused and stalls, I don't know why but it happens
  timeout 60 make -C "${DIR}/NPB3.3-SER-C/LU" CC=pgcc CLASS=C TA=nvidia,cc60 
  status=$?
} &> /dev/null

if [ "$status" == "0" ]; then
  ulimit -s unlimited #To stop segmentation faults 
  temp_file=$(mktemp /tmp/XXXX)
  timeout 60000 "${DIR}/NPB3.3-SER-C/LU/lu.C.x" &>$temp_file
  status=$?
  
  if [ "$status" != "0" ]; then
    echo -1
  else
    time_val=$(cat $temp_file | awk '($1=="Time" && $2=="in" && $3=="seconds" && $4=="="){print $5}')
    if [ "$time_val" == "" ]; then
      echo -1
    else
      verified=$(cat $temp_file | awk '($1=="Verification" && $2=="="){print $3}')
      if [ "$verified" == "SUCCESSFUL" ]; then
        echo $time_val
      else
        echo -1
      fi
    fi
  fi
else
  echo -1
fi

{
  if [ ! -z "$1" ]; then
    (cd / && patch -R -p0) <$1
  fi
} &>/dev/null
